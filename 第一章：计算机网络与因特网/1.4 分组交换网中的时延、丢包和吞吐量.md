### 1.4.0 **网络服务的理想与现实**

- **理想目标**：在任意两个终端之间即时、无限量、无丢失地传输数据。
- **现实情况**：
  - 存在带宽限制（吞吐量受限）
  - 数据传输存在延迟
  - 数据包可能发生丢失
- **意义**：这些限制催生出大量研究问题，成为网络课程和研究的核心内容。

### 1.4.1 **分组在网络中传输的延迟类型（Nodal Delay）**

- 时延类型
  当一个数据包从一个节点（主机或路由器）传输到下一个节点时，会经历以下**四类延迟**：
  1. **处理延迟 (Processing Delay, dproc)**
     - 内容：检查包头、决定转发路径、检测比特错误等。
     - 特点：通常非常短，在高速路由器中为微秒级。
  2. **排队延迟 (Queuing Delay, dqueue)**
     - 内容：等待前面数据包发送完毕的时间。
     - 影响因素：队列中已有的包数量、流量强度及其特性。
     - 范围：微秒至毫秒不等，**易受网络负载影响**。
  3. **传输延迟 (Transmission Delay, dtrans)**
     - 定义：将数据包的所有比特“推出”到链路所需的时间。
     - 公式：**L / R**
     - L = 数据包长度（比特）
     - R = 链路传输速率（比特/秒）
     - 与包长和链路速率相关，**与距离无关**。
  4. **传播延迟 (Propagation Delay, dprop)**
     - 定义：比特在链路上传播到下一节点所需的时间。
     - 公式：**d / s**
     - d = 路径距离
     - s = 传播速率（通常是光速的某个比例）
     - 与传输距离相关，**与包大小无关**。
  - **🧮  总节点延迟：**
    $d_{nodal} = d_{proc} + d_{queue} + d_{trans} + d_{prop}$
  - **传输延迟 vs. 传播延迟的区别与类比**
    - **传输延迟**：向链路“推出”数据的时间（受数据量和带宽影响）
    - **传播延迟**：比特在链路上传播的时间（受物理距离和介质影响）
      **🚗 类比：收费站上的车队**
    - 每辆车 = 一个比特，车队 = 一个数据包，收费站 = 路由器
    - 车进入高速的时间 = 传输延迟
    - 车从一个收费站行驶到下一个的时间 = 传播延迟
  - **不同网络环境下的延迟变化**
    - 本地网络中，**传播延迟通常很小**（微秒级）
    - 卫星链路等长距离通信中，**传播延迟可达数百毫秒**
    - 低速网络中（如拨号），**传输延迟可能是主要因素**
    - **排队延迟**波动性最大，受实时流量影响显著

### 1.4.2 **排队延迟与丢包（Queuing Delay and Packet Loss）**

1. **排队延迟（Queuing Delay）是最复杂且动态变化的延迟**
   - **✅ 特点**
     - 与处理、传输、传播延迟不同，**排队延迟高度不确定**，随网络状态变化。
     - **统计特性**常用于描述排队延迟：
       - 平均排队延迟（average delay）
       - 延迟方差（variance）
       - 超过某一特定值的概率
   - **✅ 影响排队延迟的关键因素**
     1. **到达速率 a（packet/sec）**
     2. **链路传输速率 R（bit/sec）**
     3. **数据包长度 L（bit）**
     4. **流量特性**（周期性 or 突发性）
2. **流量强度（Traffic Intensity）是排队延迟的重要指标**
   - **定义：**
     $\text{Traffic Intensity} = \frac{L \cdot a}{R}$
     其中：
     - L = 每个数据包的大小（比特）
     - a = 平均包到达速率（包/秒）
     - R = 链路的传输速率（比特/秒）
   - **典型情形分析**
     | **情况** | **描述** | **结果** |
     | --------------------- | ------------------- | ------------------------------------ |
     | $\frac{La}{R} > 1$ | 到达速率 > 发送速率 | **队列不断增长，排队延迟趋于无穷大** |
     | $\frac{La}{R} \leq 1$ | 系统可稳定运行 | 排队延迟取决于到达流量的形态 |
3. **流量模式对延迟的影响**
   - **✅ 周期性到达**
     - **理想情况**：每隔 $\frac{L}{R}$ 秒到达一个包，队列总为空 ⇒ 排队延迟为 0
     - **突发性周期到达**：如每隔 (L/R)N 秒到达 N 个包：
       - 第 1 个包排队延迟 = 0
       - 第 n 个包排队延迟 = $(n-1) \cdot \frac{L}{R}$
   - **✅ 随机到达（现实情况）**
     - 到达时间间隔不规则
     - $\frac{La}{R}$ 不足以完全预测排队延迟
     - **当流量强度接近 1 时**，即使未超载，仍可能因偶发突发流量而导致严重排队
4. **平均排队延迟随流量强度增长的趋势**
   - 平均排队延迟 **非线性增长**
   - 当流量强度接近 1 时，**延迟急剧上升**
   - 类比现实生活中的交通高峰：轻微增加的车流可能引发巨大延误
5. **丢包（Packet Loss）的产生**
   - **✅ 原因：**
     - 实际队列容量有限，**当队列满时新到数据包无处存放 ⇒ 被丢弃**
   - **✅ 后果：**
     - **数据包无法送达终端系统**
     - 丢包率随着流量强度上升而上升
     - 网络性能评估需考虑两项指标：
       - **延迟**
       - **丢包率（Packet Loss Probability）**
   - **✅ 应对机制：**
     - **端到端重传**：通过协议机制在传输层重传丢失的数据包（如 TCP）

### 1.4.3 端到端时延

1. **端到端延迟的组成（End-to-End Delay）**
   - **✅ 概念：**从**源主机到目的地主机**的数据包传输总延迟，由经过的所有节点的延迟累加而成。
   - **✅ 理想无拥塞条件下的计算公式：**
     $d_{\text{end-to-end}} = N \cdot (d_{\text{proc}} + d_{\text{trans}} + d_{\text{prop}})$
     - $N$ = 源与目的地之间的节点数（包括源、路由器和目的地）
     - $d_{\text{proc}}$：处理延迟
     - $d_{\text{trans}} = \frac{L}{R}$：传输延迟（L 为包长度，R 为链路速率）
     - $d_{\text{prop}}$：传播延迟
   - ✅ 注意：该公式**不包含排队延迟**，也假设每个节点的参数相同。
2. **Traceroute 工具：测量端到端路由和延迟**
   - **✅ 功能：**
     - **揭示数据包从源到目的地经过的路由器路径**
     - **测量每跳（hop）的往返时间（RTT, Round-Trip Time）**
   - **✅ 工作原理：**
     - 源主机发送 N 个特殊标记的数据包（TTL 从 1 到 N）
     - 每个中间路由器在 TTL 用尽时返回 ICMP 消息
     - 源主机记录返回时间以估算延迟
   - **✅ 输出示例说明：**
     - 每行表示一个跳数（路由器）
     - 包括：序号、路由器名称、IP 地址、3 次试验的往返延迟（单位：ms）
     - 若某跳没有回应，则显示为 \*
   - ✅ 实例观察：
     - 从美国 UMass 到法国 Sorbonne 共经过 **14 个路由器**
     - **Router 7 → Router 8** 出现明显 RTT 激增（跨越大西洋的光缆，传播延迟大）
3. **RTT 变化的意义与排队延迟**
   - 往返延迟包括：处理 + 排队 + 传输 + 传播延迟
   - 排队延迟不稳定 ⇒ 某些 RTT 会高于后续路由器（如例中 Router 11 比 Router 12 延迟大）
   - 网络拥塞时 RTT 抖动更明显
4. **其他重要的系统级延迟**

   | **类型**                            | **描述**                                                             |
   | ----------------------------------- | -------------------------------------------------------------------- |
   | **共享信道接入延迟**                | 终端在共享介质（如 WiFi）中需要等待合适时机发送数据                  |
   | **打包延迟（Packetization Delay）** | 在语音应用中，发送端需将一定时长的语音编码打包 ⇒ VoIP 应用中影响显著 |

### 1.4.3 **计算机网络中的吞吐量**

1. **吞吐量的定义（Throughput）**
   - **✅ 概念：**
     - **瞬时吞吐量（Instantaneous Throughput）**：某一时刻接收端实际接收数据的速率（bit/sec）
     - **平均吞吐量（Average Throughput）**：
       $\text{Throughput}_{avg} = \frac{F}{T}$
       - F = 文件大小（bits）
       - T = 文件传输总耗时（秒）
   - **✅ 不同应用对吞吐量的要求：**
     - **实时应用（VoIP、视频通话）**：需要**稳定且不低于某阈值的瞬时吞吐量**
     - **非实时应用（文件下载）**：期望**最大可能的平均吞吐量**
2. **简单两链路模型下的吞吐量计算**
   - **✅ 场景：**
     - 服务器 → 路由器 → 客户端，共两段链路
     - $R_s$ = 服务器到路由器的带宽
     - $R_c$ = 路由器到客户端的带宽
   - **✅ 吞吐量公式：**
     $\text{Throughput} = \min\{R_s, R_c\}$
     - **瓶颈链路决定最终吞吐量**
     - 示例：
       - MP3 文件：F = 32 Mb
       - R_s = 2 Mbps，R_c = 1 Mbps
       - 传输时间 ≈ 32 Mb / 1 Mbps = **32 秒**
3. **多链路路径下的吞吐量**
   - **✅ 多跳路径中每条链路速率为** $R_1, R_2, …, R_N$
     $\text{Throughput} = \min\{R_1, R_2, …, R_N\}$
   - 路径中最慢的链路决定了整体吞吐量
4. **现代互联网的典型结构：接入链路为瓶颈**
   - **✅ 场景：**
     - 核心网络链路速率远高于接入链路速率
     - 客户端/服务器分别通过 $R_s, R_c$ 接入核心网络
       $\text{Throughput} = \min\{R_s, R_c\}$
   - **现代互联网常见瓶颈**：接入链路（如家庭宽带、移动网络）
5. **多连接并发场景下的吞吐量分配**
   - **✅ 场景：**
     - 10 个服务器与 10 个客户端同时通信，途经核心中一条共享链路 R
   - **✅ 情况分析：**
     - 若 $R ≫ R_s, R_c$：吞吐量仍为 $\min\{R_s, R_c\}$
     - 若 R 与接入链路同量级 ⇒ 每个流量将**平分共享链路带宽**
   - **✅ 示例：**
     - $R_s$ = 2 Mbps，$R_c$ = 1 Mbps，$R$ = 5 Mbps
     - 共享链路被 10 个连接平分 ⇒ 每个吞吐量 = **500 kbps**
6. **总结：影响吞吐量的主要因素**

   | **因素** | **说明**                               |
   | -------- | -------------------------------------- |
   | 链路带宽 | 最小带宽链路决定吞吐量                 |
   | 接入速率 | 常为瓶颈，尤其在家庭/移动网络          |
   | 并发流量 | 共用链路时，实际吞吐量受共享影响       |
   | 网络拥塞 | 非空闲网络中，竞争链路资源将限制吞吐量 |

### 1.4.4 **_要点总结_**

1. **🧩 网络性能的三大核心指标**

   | **性能指标**             | **描述**                   | **关键关注点**   |
   | ------------------------ | -------------------------- | ---------------- |
   | **延迟（Delay）**        | 数据从源到目的地所需的时间 | 由多个组件组成   |
   | **丢包（Packet Loss）**  | 数据包在传输过程中被丢弃   | 多因拥塞引起     |
   | **吞吐量（Throughput）** | 数据成功到达目的地的速率   | 瓶颈链路决定上限 |

2. **🕒 节点延迟的四个组成部分**

   | **类型**               | **描述**               | **特点**               |
   | ---------------------- | ---------------------- | ---------------------- |
   | **处理延迟** $dₚᵣₒc$   | 处理包头、差错检查     | 微秒级，通常较小       |
   | **排队延迟** $d_qᵤₑᵤₑ$ | 等待前面包发送完的时间 | 高度不确定，随负载波动 |
   | **传输延迟** $dₜᵣₐₙₛ$  | 将包推入链路所需时间   | L/R，与距离无关        |
   | **传播延迟** $dₚᵣₒₚ$   | 比特在链路上传播时间   | d/s，与介质和距离相关  |

   📌 **总节点延迟公式：**

   $d_{nodal} = d_{proc} + d_{queue} + d_{trans} + d_{prop}$

3. **📉 排队延迟与丢包**
   - **✅ 流量强度定义：**
     $\text{Traffic Intensity} = \frac{L \cdot a}{R}$
     - $L$：数据包大小，$a$：到达速率，$R$：链路带宽
   - **✅ 分析要点：**
     | **情况**    | **含义**         | **结果**               |
     | ----------- | ---------------- | ---------------------- |
     | La/R > 1    | 到达速率超出带宽 | 延迟趋于无穷，产生丢包 |
     | La/R \leq 1 | 系统可稳定       | 延迟随流量特性变化     |
   - **随机流量中：**
     - 流量强度接近 1 ⇒ 排队延迟急剧上升
     - 丢包发生于队列溢出（缓冲区满）
4. **端到端延迟**
   - **✅ 理想状态下总延迟：**
     $d_{end-to-end} = N \cdot (d_{proc} + d_{trans} + d_{prop})$
   - **✅ 工具：Traceroute**
     - 跟踪路径中每一跳的延迟（往返时间 RTT）
     - 可观察到排队波动、传播延迟（如跨大西洋连接）
   - **✅ 其他终端相关延迟：**
     - **共享信道接入延迟**（如 WiFi 等）
     - **打包延迟（packetization delay）**：VoIP 中常见
5. **📦 吞吐量**
   - **✅ 平均吞吐量定义：**
     $\text{Throughput}_{avg} = \frac{F}{T}$
   - **✅ 瓶颈决定吞吐量：**
     | **网络结构**   | **吞吐量公式**                             |
     | -------------- | ------------------------------------------ |
     | 两链路模型     | $\min(R_s, R_c)$                           |
     | 多链路路径     | $\min(R_1, R_2, …, R_N)$                   |
     | 多用户共享链路 | 单连接吞吐量 = $R / n$（若共享链路为瓶颈） |
   - **现代互联网特点**：接入链路通常是瓶颈（核心网络带宽高）
